<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}FinanceApp{% endblock %}</title>
  <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
  <style type="text/tailwindcss">
    /* ── Error field state ── */
    .field-error input,
    .field-error select,
    .field-error textarea {
      @apply border-red-400 ring-2 ring-red-500/20;
    }

    /* ── Loading bar ── */
    #nprogress {
      position: fixed; top: 0; left: 0; height: 2px; width: 0;
      background: #818cf8; z-index: 9999; pointer-events: none;
      transition: width 0.25s ease, opacity 0.4s ease;
    }

    /* ── Content fade-in after HTMX swap ── */
    #content { animation: none; }
    #content.htmx-settling { animation: fadein 0.18s ease; }
    @keyframes fadein { from { opacity: 0.4; } to { opacity: 1; } }
  </style>
</head>
<body class="h-full">

<!-- Progress bar -->
<div id="nprogress"></div>

<!-- Toast messages -->
{% if messages %}
<div class="fixed top-4 right-4 z-50 space-y-2" id="toast-container">
  {% for message in messages %}
  <div class="flex items-center px-4 py-3 rounded-lg shadow-lg text-sm font-medium
              {% if message.tags == 'success' %}bg-green-500 text-white
              {% elif message.tags == 'error' %}bg-red-500 text-white
              {% elif message.tags == 'warning' %}bg-yellow-400 text-gray-900
              {% else %}bg-blue-500 text-white{% endif %}">
    {{ message }}
    <button onclick="this.parentElement.remove()" class="ml-3 font-bold opacity-75 hover:opacity-100">&times;</button>
  </div>
  {% endfor %}
</div>
{% endif %}

{% if user.is_authenticated %}
<div class="flex h-full min-h-screen">

  <!-- ─── Sidebar ─── -->
  <aside class="hidden md:flex md:flex-col w-64 bg-indigo-900 text-white flex-shrink-0">
    <div class="px-6 py-5 border-b border-indigo-800">
      <a href="{% url 'dashboard' %}" class="text-xl font-bold tracking-tight">FinanceApp</a>
    </div>

    <!-- nav links get hx-boost so they swap only #content -->
    <nav id="sidebar-nav"
         class="flex-1 px-4 py-6 space-y-1"
         hx-boost="true"
         hx-select="#content"
         hx-target="#content"
         hx-swap="outerHTML"
         hx-push-url="true">
      <a href="{% url 'dashboard' %}"
         class="nav-link flex items-center px-3 py-2 rounded-lg text-sm font-medium hover:bg-indigo-800 transition {% if request.resolver_match.url_name == 'dashboard' %}bg-indigo-800{% endif %}">
        <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
        </svg>
        Dashboard
      </a>
      <a href="{% url 'account_list' %}"
         class="nav-link flex items-center px-3 py-2 rounded-lg text-sm font-medium hover:bg-indigo-800 transition {% if 'account' in request.resolver_match.url_name %}bg-indigo-800{% endif %}">
        <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
        </svg>
        Accounts
      </a>
      <a href="{% url 'transaction_list' %}"
         class="nav-link flex items-center px-3 py-2 rounded-lg text-sm font-medium hover:bg-indigo-800 transition {% if 'transaction' in request.resolver_match.url_name %}bg-indigo-800{% endif %}">
        <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        Transactions
      </a>
      <a href="{% url 'category_list' %}"
         class="nav-link flex items-center px-3 py-2 rounded-lg text-sm font-medium hover:bg-indigo-800 transition {% if 'category' in request.resolver_match.url_name %}bg-indigo-800{% endif %}">
        <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A2 2 0 013 12V7a2 2 0 012-2z"/>
        </svg>
        Categories
      </a>
      <a href="{% url 'budget_list' %}"
         class="nav-link flex items-center px-3 py-2 rounded-lg text-sm font-medium hover:bg-indigo-800 transition {% if 'budget' in request.resolver_match.url_name %}bg-indigo-800{% endif %}">
        <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
        Budgets
      </a>
    </nav>

    <div class="px-4 py-4 border-t border-indigo-800">
      <div class="flex items-center justify-between">
        <span class="text-sm text-indigo-300 truncate">{{ user.username }}</span>
        <!-- Logout is outside hx-boost scope — stays a normal full-page request -->
        <a href="{% url 'logout' %}" class="text-xs text-indigo-400 hover:text-white transition ml-2 flex-shrink-0">Logout</a>
      </div>
    </div>
  </aside>

  <!-- ─── Main column ─── -->
  <div class="flex-1 flex flex-col min-w-0">

    <!-- Mobile top bar -->
    <header class="md:hidden bg-indigo-900 text-white px-4 py-3 flex items-center justify-between flex-shrink-0">
      <a href="{% url 'dashboard' %}" class="text-lg font-bold">FinanceApp</a>
      <button id="mobile-toggle" class="p-2 rounded-md hover:bg-indigo-800">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    </header>

    <!-- Mobile nav menu — boosted same as sidebar -->
    <nav id="mobile-menu"
         class="hidden md:hidden bg-indigo-800 text-white px-4 py-3 space-y-1 flex-shrink-0"
         hx-boost="true"
         hx-select="#content"
         hx-target="#content"
         hx-swap="outerHTML"
         hx-push-url="true">
      <a href="{% url 'dashboard' %}" class="block px-3 py-2 rounded-md text-sm hover:bg-indigo-700">Dashboard</a>
      <a href="{% url 'account_list' %}" class="block px-3 py-2 rounded-md text-sm hover:bg-indigo-700">Accounts</a>
      <a href="{% url 'transaction_list' %}" class="block px-3 py-2 rounded-md text-sm hover:bg-indigo-700">Transactions</a>
      <a href="{% url 'category_list' %}" class="block px-3 py-2 rounded-md text-sm hover:bg-indigo-700">Categories</a>
      <a href="{% url 'budget_list' %}" class="block px-3 py-2 rounded-md text-sm hover:bg-indigo-700">Budgets</a>
      <a href="{% url 'logout' %}" hx-boost="false" class="block px-3 py-2 rounded-md text-sm hover:bg-indigo-700">Logout</a>
    </nav>

    <!-- ─── Page content — the ONLY element swapped by HTMX ─── -->
    <main id="content"
          class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50"
          hx-boost="true"
          hx-select="#content"
          hx-target="#content"
          hx-swap="outerHTML"
          hx-push-url="true">
{% endif %}

{% block content %}{% endblock %}

{% if user.is_authenticated %}
    </main>
  </div>
</div>
{% endif %}

<script>
(function () {
  /* ── Loading bar ── */
  var bar = document.getElementById('nprogress');
  var tid;
  document.addEventListener('htmx:beforeRequest', function () {
    clearTimeout(tid);
    bar.style.opacity = '1';
    bar.style.width = '65%';
  });
  document.addEventListener('htmx:afterSettle', function () {
    bar.style.width = '100%';
    tid = setTimeout(function () { bar.style.opacity = '0'; bar.style.width = '0'; }, 350);
  });

  /* ── Active nav highlight ── */
  function syncNav() {
    var path = window.location.pathname;
    document.querySelectorAll('#sidebar-nav .nav-link').forEach(function (a) {
      var href = a.getAttribute('href');
      var active = (href === '/' ? path === '/' : path.startsWith(href));
      a.classList.toggle('bg-indigo-800', active);
    });
  }
  document.addEventListener('htmx:afterSettle', syncNav);

  /* ── Toast auto-dismiss ── */
  function initToasts() {
    var el = document.getElementById('toast-container');
    if (el) setTimeout(function () { el.remove(); }, 4000);
  }
  document.addEventListener('htmx:afterSettle', initToasts);
  initToasts(); /* also run on first page load */

  /* ── Mobile menu toggle ── */
  document.addEventListener('click', function (e) {
    var btn = e.target.closest('#mobile-toggle');
    if (btn) {
      var menu = document.getElementById('mobile-menu');
      if (menu) menu.classList.toggle('hidden');
    }
  });
  /* Close mobile menu after navigation */
  document.addEventListener('htmx:afterSettle', function () {
    var menu = document.getElementById('mobile-menu');
    if (menu) menu.classList.add('hidden');
  });

  /* ── Page title update ── */
  document.addEventListener('htmx:afterSettle', function (e) {
    try {
      var resp = e.detail.xhr && e.detail.xhr.responseText;
      if (resp) {
        var m = resp.match(/<title>([^<]*)<\/title>/i);
        if (m) document.title = m[1];
      }
    } catch (_) {}
  });
})();
</script>

</body>
</html>
